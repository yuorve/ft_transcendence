{
  "version": 3,
  "sources": ["../../../dev/core/src/FlowGraph/Blocks/Data/flowGraphCachedOperationBlock.ts"],
  "sourcesContent": ["import type { Nullable } from \"../../../types\";\r\nimport type { IFlowGraphBlockConfiguration } from \"../../flowGraphBlock\";\r\nimport { FlowGraphBlock } from \"../../flowGraphBlock\";\r\nimport type { FlowGraphContext } from \"../../flowGraphContext\";\r\nimport type { FlowGraphDataConnection } from \"../../flowGraphDataConnection\";\r\nimport type { RichType } from \"../../flowGraphRichTypes\";\r\nimport { RichTypeBoolean } from \"../../flowGraphRichTypes\";\r\n\r\nconst cacheName = \"cachedOperationValue\";\r\nconst cacheExecIdName = \"cachedExecutionId\";\r\n\r\n/**\r\n * A block that will cache the result of an operation and deliver it as an output.\r\n */\r\nexport abstract class FlowGraphCachedOperationBlock<OutputT> extends FlowGraphBlock {\r\n    /**\r\n     * The output of the operation\r\n     */\r\n    public readonly value: FlowGraphDataConnection<OutputT>;\r\n\r\n    /**\r\n     * Output connection: Whether the value is valid.\r\n     */\r\n    public readonly isValid: FlowGraphDataConnection<boolean>;\r\n\r\n    constructor(outputRichType: RichType<OutputT>, config?: IFlowGraphBlockConfiguration) {\r\n        super(config);\r\n\r\n        this.value = this.registerDataOutput(\"value\", outputRichType);\r\n        this.isValid = this.registerDataOutput(\"isValid\", RichTypeBoolean);\r\n    }\r\n\r\n    /**\r\n     * @internal\r\n     * Operation to realize\r\n     * @param context the graph context\r\n     */\r\n    public abstract _doOperation(context: FlowGraphContext): OutputT | undefined;\r\n\r\n    public override _updateOutputs(context: FlowGraphContext) {\r\n        const cachedExecutionId = context._getExecutionVariable(this, cacheExecIdName, -1);\r\n        const cachedValue = context._getExecutionVariable<Nullable<OutputT>>(this, cacheName, null);\r\n        if (cachedValue !== undefined && cachedValue !== null && cachedExecutionId === context.executionId) {\r\n            this.isValid.setValue(true, context);\r\n            this.value.setValue(cachedValue, context);\r\n        } else {\r\n            try {\r\n                const calculatedValue = this._doOperation(context);\r\n                if (calculatedValue === undefined || calculatedValue === null) {\r\n                    this.isValid.setValue(false, context);\r\n                    return;\r\n                }\r\n                context._setExecutionVariable(this, cacheName, calculatedValue);\r\n                context._setExecutionVariable(this, cacheExecIdName, context.executionId);\r\n                this.value.setValue(calculatedValue, context);\r\n                this.isValid.setValue(true, context);\r\n            } catch (e) {\r\n                this.isValid.setValue(false, context);\r\n            }\r\n        }\r\n    }\r\n}\r\n"],
  "mappings": ";;;;;;AAQA,IAAM,YAAY;AAClB,IAAM,kBAAkB;AAKlB,IAAgB,gCAAhB,cAA+D,eAAc;EAW/E,YAAY,gBAAmC,QAAqC;AAChF,UAAM,MAAM;AAEZ,SAAK,QAAQ,KAAK,mBAAmB,SAAS,cAAc;AAC5D,SAAK,UAAU,KAAK,mBAAmB,WAAW,eAAe;EACrE;EASgB,eAAe,SAAyB;AACpD,UAAM,oBAAoB,QAAQ,sBAAsB,MAAM,iBAAiB,EAAE;AACjF,UAAM,cAAc,QAAQ,sBAAyC,MAAM,WAAW,IAAI;AAC1F,QAAI,gBAAgB,UAAa,gBAAgB,QAAQ,sBAAsB,QAAQ,aAAa;AAChG,WAAK,QAAQ,SAAS,MAAM,OAAO;AACnC,WAAK,MAAM,SAAS,aAAa,OAAO;IAC5C,OAAO;AACH,UAAI;AACA,cAAM,kBAAkB,KAAK,aAAa,OAAO;AACjD,YAAI,oBAAoB,UAAa,oBAAoB,MAAM;AAC3D,eAAK,QAAQ,SAAS,OAAO,OAAO;AACpC;QACJ;AACA,gBAAQ,sBAAsB,MAAM,WAAW,eAAe;AAC9D,gBAAQ,sBAAsB,MAAM,iBAAiB,QAAQ,WAAW;AACxE,aAAK,MAAM,SAAS,iBAAiB,OAAO;AAC5C,aAAK,QAAQ,SAAS,MAAM,OAAO;MACvC,SAAS,GAAG;AACR,aAAK,QAAQ,SAAS,OAAO,OAAO;MACxC;IACJ;EACJ;;",
  "names": []
}
