{
  "version": 3,
  "sources": ["../../../dev/core/src/FlowGraph/Blocks/Execution/Animation/flowGraphStopAnimationBlock.ts"],
  "sourcesContent": ["import type { FlowGraphContext } from \"../../../flowGraphContext\";\r\nimport type { FlowGraphDataConnection } from \"../../../flowGraphDataConnection\";\r\nimport { RichTypeAny, RichTypeNumber } from \"../../../flowGraphRichTypes\";\r\nimport type { IFlowGraphBlockConfiguration } from \"../../../flowGraphBlock\";\r\nimport { RegisterClass } from \"../../../../Misc/typeStore\";\r\nimport type { AnimationGroup } from \"core/Animations/animationGroup\";\r\nimport { FlowGraphBlockNames } from \"../../flowGraphBlockNames\";\r\nimport { Logger } from \"core/Misc/logger\";\r\nimport { FlowGraphAsyncExecutionBlock } from \"core/FlowGraph/flowGraphAsyncExecutionBlock\";\r\n/**\r\n * @experimental\r\n * Block that stops a running animation\r\n */\r\nexport class FlowGraphStopAnimationBlock extends FlowGraphAsyncExecutionBlock {\r\n    /**\r\n     * Input connection: The animation to stop.\r\n     */\r\n    public readonly animationGroup: FlowGraphDataConnection<AnimationGroup>;\r\n\r\n    /**\r\n     * Input connection - if defined (positive integer) the animation will stop at this frame.\r\n     */\r\n    public readonly stopAtFrame: FlowGraphDataConnection<number>;\r\n\r\n    constructor(config?: IFlowGraphBlockConfiguration) {\r\n        super(config);\r\n        this.animationGroup = this.registerDataInput(\"animationGroup\", RichTypeAny);\r\n        this.stopAtFrame = this.registerDataInput(\"stopAtFrame\", RichTypeNumber, -1);\r\n    }\r\n\r\n    public override _preparePendingTasks(context: FlowGraphContext): void {\r\n        const animationToStopValue = this.animationGroup.getValue(context);\r\n        const stopAtFrame = this.stopAtFrame.getValue(context) ?? -1;\r\n        // get the context variable\r\n        const pendingStopAnimations = context._getGlobalContextVariable(\r\n            \"pendingStopAnimations\",\r\n            [] as {\r\n                uniqueId: number;\r\n                stopAtFrame: number;\r\n            }[]\r\n        );\r\n        // add the animation to the list\r\n        pendingStopAnimations.push({ uniqueId: animationToStopValue.uniqueId, stopAtFrame });\r\n        // set the global context variable\r\n        context._setGlobalContextVariable(\"pendingStopAnimations\", pendingStopAnimations);\r\n    }\r\n    public override _cancelPendingTasks(context: FlowGraphContext): void {\r\n        // remove the animation from the list\r\n        const animationToStopValue = this.animationGroup.getValue(context);\r\n        const pendingStopAnimations = context._getGlobalContextVariable(\r\n            \"pendingStopAnimations\",\r\n            [] as {\r\n                uniqueId: number;\r\n                stopAtFrame: number;\r\n            }[]\r\n        );\r\n        for (let i = 0; i < pendingStopAnimations.length; i++) {\r\n            if (pendingStopAnimations[i].uniqueId === animationToStopValue.uniqueId) {\r\n                pendingStopAnimations.splice(i, 1);\r\n                // set the global context variable\r\n                context._setGlobalContextVariable(\"pendingStopAnimations\", pendingStopAnimations);\r\n                break;\r\n            }\r\n        }\r\n    }\r\n\r\n    public _execute(context: FlowGraphContext): void {\r\n        const animationToStopValue = this.animationGroup.getValue(context);\r\n        const stopTime = this.stopAtFrame.getValue(context) ?? -1;\r\n        // check the values\r\n        if (!animationToStopValue) {\r\n            Logger.Warn(\"No animation group provided to stop.\");\r\n            return this._reportError(context, \"No animation group provided to stop.\");\r\n        }\r\n        if (isNaN(stopTime)) {\r\n            return this._reportError(context, \"Invalid stop time.\");\r\n        }\r\n        if (stopTime > 0) {\r\n            this._startPendingTasks(context);\r\n        } else {\r\n            this._stopAnimation(animationToStopValue, context);\r\n        }\r\n        // note that out will not be triggered in case of an error\r\n        this.out._activateSignal(context);\r\n    }\r\n\r\n    public override _executeOnTick(context: FlowGraphContext): void {\r\n        const animationToStopValue = this.animationGroup.getValue(context);\r\n        // check each frame if any animation should be stopped\r\n        const pendingStopAnimations = context._getGlobalContextVariable(\"pendingStopAnimations\", [] as { uniqueId: number; stopAtFrame: number }[]);\r\n        for (let i = 0; i < pendingStopAnimations.length; i++) {\r\n            // compare the uniqueId to the animation to stop\r\n            if (pendingStopAnimations[i].uniqueId === animationToStopValue.uniqueId) {\r\n                // check if the current frame is AFTER the stopAtFrame\r\n                if (animationToStopValue.getCurrentFrame() >= pendingStopAnimations[i].stopAtFrame) {\r\n                    // stop the animation\r\n                    this._stopAnimation(animationToStopValue, context);\r\n                    // remove the animation from the list\r\n                    pendingStopAnimations.splice(i, 1);\r\n                    // set the global context variable\r\n                    context._setGlobalContextVariable(\"pendingStopAnimations\", pendingStopAnimations);\r\n                    this.done._activateSignal(context);\r\n                    context._removePendingBlock(this);\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @returns class name of the block.\r\n     */\r\n    public override getClassName(): string {\r\n        return FlowGraphBlockNames.StopAnimation;\r\n    }\r\n\r\n    private _stopAnimation(animationGroup: AnimationGroup, context: FlowGraphContext): void {\r\n        const currentlyRunning = context._getGlobalContextVariable(\"currentlyRunningAnimationGroups\", []) as number[];\r\n        const index = currentlyRunning.indexOf(animationGroup.uniqueId);\r\n        if (index !== -1) {\r\n            animationGroup.stop();\r\n            currentlyRunning.splice(index, 1);\r\n            // update the global context variable\r\n            context._setGlobalContextVariable(\"currentlyRunningAnimationGroups\", currentlyRunning);\r\n        } else {\r\n            // Logger.Warn(\"Trying to stop an animation that is not running.\");\r\n            // no-op for now. Probably no need to log anything here.\r\n        }\r\n    }\r\n}\r\nRegisterClass(FlowGraphBlockNames.StopAnimation, FlowGraphStopAnimationBlock);\r\n"],
  "mappings": ";;;;;;;;;;;;;;;AAaM,IAAO,8BAAP,cAA2C,6BAA4B;EAWzE,YAAY,QAAqC;AAC7C,UAAM,MAAM;AACZ,SAAK,iBAAiB,KAAK,kBAAkB,kBAAkB,WAAW;AAC1E,SAAK,cAAc,KAAK,kBAAkB,eAAe,gBAAgB,EAAE;EAC/E;EAEgB,qBAAqB,SAAyB;AAC1D,UAAM,uBAAuB,KAAK,eAAe,SAAS,OAAO;AACjE,UAAM,cAAc,KAAK,YAAY,SAAS,OAAO,KAAK;AAE1D,UAAM,wBAAwB,QAAQ,0BAClC,yBACA,CAAA,CAGG;AAGP,0BAAsB,KAAK,EAAE,UAAU,qBAAqB,UAAU,YAAW,CAAE;AAEnF,YAAQ,0BAA0B,yBAAyB,qBAAqB;EACpF;EACgB,oBAAoB,SAAyB;AAEzD,UAAM,uBAAuB,KAAK,eAAe,SAAS,OAAO;AACjE,UAAM,wBAAwB,QAAQ,0BAClC,yBACA,CAAA,CAGG;AAEP,aAAS,IAAI,GAAG,IAAI,sBAAsB,QAAQ,KAAK;AACnD,UAAI,sBAAsB,CAAC,EAAE,aAAa,qBAAqB,UAAU;AACrE,8BAAsB,OAAO,GAAG,CAAC;AAEjC,gBAAQ,0BAA0B,yBAAyB,qBAAqB;AAChF;MACJ;IACJ;EACJ;EAEO,SAAS,SAAyB;AACrC,UAAM,uBAAuB,KAAK,eAAe,SAAS,OAAO;AACjE,UAAM,WAAW,KAAK,YAAY,SAAS,OAAO,KAAK;AAEvD,QAAI,CAAC,sBAAsB;AACvB,aAAO,KAAK,sCAAsC;AAClD,aAAO,KAAK,aAAa,SAAS,sCAAsC;IAC5E;AACA,QAAI,MAAM,QAAQ,GAAG;AACjB,aAAO,KAAK,aAAa,SAAS,oBAAoB;IAC1D;AACA,QAAI,WAAW,GAAG;AACd,WAAK,mBAAmB,OAAO;IACnC,OAAO;AACH,WAAK,eAAe,sBAAsB,OAAO;IACrD;AAEA,SAAK,IAAI,gBAAgB,OAAO;EACpC;EAEgB,eAAe,SAAyB;AACpD,UAAM,uBAAuB,KAAK,eAAe,SAAS,OAAO;AAEjE,UAAM,wBAAwB,QAAQ,0BAA0B,yBAAyB,CAAA,CAAiD;AAC1I,aAAS,IAAI,GAAG,IAAI,sBAAsB,QAAQ,KAAK;AAEnD,UAAI,sBAAsB,CAAC,EAAE,aAAa,qBAAqB,UAAU;AAErE,YAAI,qBAAqB,gBAAe,KAAM,sBAAsB,CAAC,EAAE,aAAa;AAEhF,eAAK,eAAe,sBAAsB,OAAO;AAEjD,gCAAsB,OAAO,GAAG,CAAC;AAEjC,kBAAQ,0BAA0B,yBAAyB,qBAAqB;AAChF,eAAK,KAAK,gBAAgB,OAAO;AACjC,kBAAQ,oBAAoB,IAAI;AAChC;QACJ;MACJ;IACJ;EACJ;;;;EAKgB,eAAY;AACxB,WAAA;EACJ;EAEQ,eAAe,gBAAgC,SAAyB;AAC5E,UAAM,mBAAmB,QAAQ,0BAA0B,mCAAmC,CAAA,CAAE;AAChG,UAAM,QAAQ,iBAAiB,QAAQ,eAAe,QAAQ;AAC9D,QAAI,UAAU,IAAI;AACd,qBAAe,KAAI;AACnB,uBAAiB,OAAO,OAAO,CAAC;AAEhC,cAAQ,0BAA0B,mCAAmC,gBAAgB;IACzF,OAAO;IAGP;EACJ;;AAEJ,cAAa,+BAAoC,2BAA2B;",
  "names": []
}
